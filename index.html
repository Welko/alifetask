<!DOCTYPE html>
<html>
<head>
    <title>Title</title>
    <style>
    </style>
</head>
<body>
    <div id="canvasContainer"></div>

    <br/>

    <button onclick="step()">Step</button>
    <button id="play" onclick="play()">Play</button>

    <br/>

    <input type="range" id="speed" min="1" max="100" value="10" oninput="setSpeed(this.value)">
    <label for="speed" id="speedLabel"></label>
    
    <br/>

    <label for="faction">Faction</label>
    <select id="faction" onchange="faction = parseInt(this.value)">
        <option value="1">1</option>
        <option value="2">2</option>
    </select>
    
    <br/>

    <input type="range" id="intensity" min="1" max="255" value="1" oninput="setIntensity(this.value)">
    <label for="intensity" id="intensityLabel"></label>

    <script>
        let speed = document.getElementById('speed').value;
        let faction = parseInt(document.getElementById('faction').value);
        let intensity = parseInt(document.getElementById('intensity').value);

        const playButton = document.getElementById('play');
        const speedLabel = document.getElementById('speedLabel');
        const intensityLabel = document.getElementById('intensityLabel');

        let interval = null;

        function step() {
            app.update();
            app.render();
        }

        function play() {
            if (interval) {
                clearInterval(interval);
                interval = null;
            } else {
                interval = setInterval(() => {
                    app.update();
                    app.render();
                }, 1000 / speed);
            }
            playButton.innerText = interval ? 'Pause' : 'Play';
        }

        function setSpeed(value) {
            speed = value;
            speedLabel.innerText = `${speed} steps per second`;
            if (interval) {
                play();
                play();
            }
        }
        setSpeed(speed);

        function setIntensity(value) {
            intensity = value;
            intensityLabel.innerText = `Intensity: ${intensity}`;
        }
        setIntensity(intensity);
    </script>

    <script type="module">
        import ALifeTask from './src/alifetask.js';

        const width = 512;
        const height = 512;

        window.app = new ALifeTask(width, height);
        app.domElement.style.width = `${width}px`;
        app.domElement.style.height = `${height}px`;
        document.getElementById('canvasContainer').appendChild(app.domElement);

        app.initialize({width, height}).then(() => {
            const mode = 'draw';
            const radius = 5;
            
            const brush = (event, action) => {
                console.log(faction);
                const br = app.domElement.getBoundingClientRect();
                const x = event.clientX - br.left;
                const y = event.clientY - br.top;
                app.brush({ action, mode, x, y, radius, faction, intensity });
                app.render();
            };

            app.domElement.addEventListener('mousedown', (e)=>brush(e, 'down'));
            app.domElement.addEventListener('mousemove', (e)=>brush(e, 'move'));
            app.domElement.addEventListener('mouseup', (e)=>brush(e, 'up'));

            app.render();
        });
    </script>
</body>
</html>